version: "3.8"

services:
  classic-index:
    image: ghcr.io/${GITHUB_REPOSITORY:-jingyijun/classicindex}:${TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: classic-index
    restart: unless-stopped
    ports:
      - "8000:8000" # FastAPI 后端
      - "8501:8501" # Streamlit 前端
    environment:
      # DashScope (Qwen) API 配置
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      # Zilliz Cloud 配置
      - ZILLIZ_CLOUD_URI=${ZILLIZ_CLOUD_URI}
      - ZILLIZ_CLOUD_TOKEN=${ZILLIZ_CLOUD_TOKEN}
      # Milvus 集合配置
      - MILVUS_COLLECTION_NAME=${MILVUS_COLLECTION_NAME:-classic_books}
      # 书籍配置
      - BOOK_NAME=${BOOK_NAME:-马克思全集1}
    volumes:
      # 挂载书籍数据文件（可选，用于数据导入）
      - ./data:/app/data:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - classic-index-network

networks:
  classic-index-network:
    driver: bridge
